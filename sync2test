#!/bin/bash
# Script de sincronizacao de codigo-fonte com o servidor de teste
# 03/09/2009 - Luiz Sanches
# Versao 0.2

# Verifica a existencia do programa dialog
if [ ! -e "/usr/bin/dialog" ]; then
	echo "ATENCAO! E necessario instalar o programa 'dialog'."
	exit
fi

# Verifica a existencia do arquivo de configuracao, para carregamento das variaveis
if [ -e "/home/$USER/.sync2test" ]; then
	. /home/$USER/.sync2test
else
	usuario=$( dialog --stdout --inputbox 'Digite o nome do usuario:' 0 0 )
	servidor=$( dialog --stdout --inputbox 'Digite o endereco do servidor:' 0 0 )
	senha_svn=$( dialog --stdout --passwordbox 'Digite a senha do svn:' 0 0 )	
	destino=$( dialog --stdout --inputbox 'Digite o diretorio de destino:' 0 0 )

	echo "usuario=\"$usuario\"" > /home/$USER/.sync2test
	echo "servidor=\"$servidor\"" >> /home/$USER/.sync2test
	echo "senha_svn=\"$senha_svn\"" >> /home/$USER/.sync2test
	echo "dir_destino=\"$servidor:$destino\"" >> /home/$USER/.sync2test
fi

arquivo_log=".sync2test-temp.log" 
arquivo_log_permanente="sync2test.log"

# deleta o arquivo de log para mostrar somente a ultima sincronizacao
rm $arquivo_log

# Selecao de modulo
projeto=$( dialog \
	--stdout \
	--menu "Selecione o projeto a ser atualizado para o servidor de teste:" \
	0 0 0 \
	siig '' )

# se o projeto for nulo, emitir mensagem e sair
if [ -z $projeto ]
then
	dialog                                             \
		--title 'sync2test'                            \
		--msgbox 'Nenhum projeto foi selecionado. Operacao cancelada.'  \
	6 40
	exit
else
	# prepara o diretorio de sincronizacao
	dir_tmp_sync="/tmp/sync2test/$projeto"

	dir_backup="~/bkp-$projeto/`date +%Y-%m-%d-%H-%M`"

	mkdir -p $dir_tmp_sync 2> /dev/null

	# SVN update
	svn checkout svn://$servidor/var/svn/desenvolvimento/$projeto --username $usuario --password $senha_svn $dir_tmp_sync

	# Sincroniza o projeto criando um backup
	rsync -Cravzp -h -b --backup-dir=$dir_backup --delete --log-file=$arquivo_log -e "ssh -l $usuario -p 1529" $dir_tmp_sync $dir_destino

	# Atualiza o arquivo de log permanente
	cat $arquivo_log >> $arquivo_log_permanente

	dialog                                             \
		--title 'sync2test - log da atualizacao'       \
		--textbox $arquivo_log   \
	0 0
	clear
fi
